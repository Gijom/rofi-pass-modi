#!/usr/bin/env bash

FIRST_ENTRY_STR="First line (password?)"

if [ -z $@ ]; then
	shopt -s nullglob globstar
	prefix=${PASSWORD_STORE_DIR-$HOME/.password-store}
	password_files=( "$prefix"/**/*.gpg )
	password_files=( "${password_files[@]#"$prefix"/}" )
	password_files=( "${password_files[@]%.gpg}" )
	printf '%s\n' "${password_files[@]}"
else
	if [ -z $ROFI_DATA ]; then
		printf "$FIRST_ENTRY_STR\n"
		pass show "$@" | tail -n-1 | cut -s -d: -f1
		printf "\0data\x1f$@\n"
	else
		case "$@" in
			"$FIRST_ENTRY_STR")
				coproc ( pass show -c "$ROFI_DATA" >/dev/null 2>&1 )
				;;
			otpauth)
				coproc ( pass otp -c "$ROFI_DATA" >/dev/null 2>&1 )
				;;
			*)
				LINE=$(pass show "$ROFI_DATA" | grep -n -E "^$@:" | cut -s -d: -f1)
				coproc ( pass show -c"$LINE" "$ROFI_DATA" >/dev/null 2>&1 )
				;;
		esac
	fi
fi
